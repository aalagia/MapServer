<!DOCTYPE html>
<html xmlns:https="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1"/>
    <title>Mappa</title>

    <link href="static/css/bootstrap.css" rel="stylesheet">
    <link href="static/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="static/css/bootstrap-modal.css" rel="stylesheet">

    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/bootstrap.js"></script>
    <script src="static/js/bootstrap-modalmanager.js"></script>
    <script src="static/js/bootstrap-modal.js"></script>
    <script src="static/js/nunjucks.js"></script>

    <style>
        html, body { margin:0; padding:0; overflow:hidden }
        svg { position:fixed; top:0; left:0; height:100%; width:100%;
            background: -webkit-radial-gradient(#7E7A7A, #434141, #000); /* Safari 5.1 to 6.0 */
            background: -o-radial-gradient(#7E7A7A, #434141, #000); /* For Opera 11.6 to 12.0 */
            background: -moz-radial-gradient(#7E7A7A, #434141, #000); /* For Firefox 3.6 to 15 */
            background: radial-gradient(#7E7A7A, #434141, #000); /* Standard syntax */
        }
        .button {
            position: fixed;
            right: 50px;
            bottom: 50px;
            z-index: 100;
        }
        #selected{
            color: white;
        }

        image {
            -webkit-transform: translateZ(0px);
            -moz-transform: translateZ(0px);
            -ms-transform: translateZ(0px);
            -o-transform: translateZ(0px);
             transform: translateZ(0px);
        }
    </style>
    <style type="text/css">

			/*Un loader da mostrare al centro della pagina in attesa che venga completamente caricata!*/
			.no-js #loader { display: none;  }
			.js #loader { display: block; position: absolute; left: 100px; top: 0; }
			.se-pre-con {
			position: fixed;
            visibility: hidden;
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			z-index: 9999;
			background: url(static/res/images/loader1.gif) center no-repeat rgba(255,255,255,0.5);
			}
	</style>
    <script src="static/lib/snap.svg.js"></script>
    <script src="static/lib/snap.svg.zpd.js"></script>
    <script src="static/lib/svg-pan-zoom.js"></script>
    <script src="static/js/snaptoolkit.js"></script>
    <script src="static/lib/hammer.js"></script>
	<script language="JavaScript" type="text/javascript" src="static/lib/jquery-2.1.4.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="static/js/gesture/UIGestureRecognizer.js"></script>
    <script src="static/js/gesture/UIPanGestureRecognizer.js"></script>
    <script src="static/js/gesture/UIZoomGestureRecognizer.js"></script>
    <!--<script src="js/require.js"></script>-->
    <script src="static/js/swig.min.js"></script>
     <!-- ViewControllers -->
        <script src="static/js/viewcontroller/UIHelperFunctions.js"></script>
        <script src="static/js/viewcontroller/UIViewController.js"></script>
        <script src="static/js/viewcontroller/UIScrollViewController.js"></script>

    <script type="text/javascript">


    </script>

</head>

<body>

    <div class="button">

    <button id="drawSquare">Draw Square</button>
    <br/>
    <button id="drawSquareInside">Draw Square inside</button>
	<br/>
    <button id="loadIcon">Load Icon</button>
	<br/>
	<button id="loadIconInside">Load Icon inside</button>
	<br/>
	<button id="circle">Circle</button>
    <br/>
    <button id="loadDocument">Load Document</button>
    <br/>
    <button id="addDocument">Add Document</button>
        <br/>
        <button id="reset">Reset</button>
        <br/>
    <button id="tablet" onclick="function tablet() {
            alert(NativeInterface.tablet());
    }
    tablet()">Tablet</button>

    <div id="lightboxform" class="modal hide fade" tabindex="-1" data-width="500">
        <div class="se-pre-con"></div>
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
            <h4>Add Document</h4>
        </div>
        <div class="modal-body">
		<form enctype="multipart/form-data" method="post" id="uploadForm" class="form-horizontal">
            <div class="control-group">
			    <label class="control-label">Title </label>
			    <div class="controls">
                    <input type="text" id="inputTitle" placeholder="Title" required>
			    </div>
            </div>
            <div class="control-group">
			    <label class="control-label">Type </label>
			    <div class="controls">
                    <select id="documents">
                        <option value="still">Still</option>
                        <option value="video">Video</option>
                        <option value="doc">Doc</option>

                    </select>

			</div>

		  </div>
            <div class="control-group">
			    <label class="control-label">File </label>
			    <div class="controls">
                    <input type="file" id="inputFile" required capture>
			    </div>
            </div>
		  <div class="control-group">
			<label class="control-label">Pos X</label>
			<div class="controls">
                <p id="posX" class="control-label">{{addX}}</p>

			</div>

		  </div>
            <div class="control-group">
			<label class="control-label">Pos Y</label>
			<div class="controls">
                <p id="posY" class="control-label">{{addY}}</p>

			</div>

		  </div>
            <div class="control-group">
			    <label class="control-label">Comment </label>
			    <div class="controls">
                    <input type="text" id="inputComment" placeholder="Comment">
			    </div>
            </div>
             <div class="modal-footer">
		        <input id="submitButton" class="btn" value="Send" type="submit">
            </div>

        </form>
	  </div>
    </div>

</div>

<a href="#lightboxmap" id="openMap" data-toggle="modal"></a>
<div id="lightboxfile" class="modal hide fade" tabindex="-1" data-width="500">
        <div class="se-pre-con"></div>
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
            <h4>Open Document</h4>
        </div>
</div>

<div id="lightboxmap" class="modal hide fade" tabindex="-1" data-width="500">
        <div class="se-pre-con"></div>
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
            <h4>Open Map</h4>
        </div>
</div>

</body>
<script>


    var paper = Snap();
    var media = {};
    var panZoom;
    var x_pan;
    var y_pan;
    var zoom;
    var loaded = false;
    var metro = 4639.11976;
    var indirizzo_ip = "172.16.2.34:8080";
    //var indirizzo_ip = "192.168.0.102:8080"
    init();
    var timeout = window.setInterval(pan, 100);

    function pan(){
        if (document.getElementById('GroupIcons')!=null) {
            var matrix = document.getElementById("GroupIcons").getCTM()
            x_pan = (48 * matrix.a) / 0.008;
            y_pan = (21 * matrix.a) / 0.008;
            zoom = matrix.a;
            panZoom.pan({x: x_pan, y: y_pan})
            window.clearInterval(timeout);
        }
    }


    function init(){
        requestMap();
        //loadSVG();
    }
   function requestMap(){



       var xhr = new XMLHttpRequest();

       // Open the connection.
        xhr.open('GET', "/maplist/", true);

        xhr.onload = function () {
            if (xhr.status === 201) {
                var risp = JSON.parse(xhr.responseText);
                 var elementlist = document.getElementById("listMap")
                    if (elementlist != null)
                        elementlist.remove();
                    var list = document.createElement('ul');
                    list.id = "listMap";
                for (var i=0; i<risp.length; i++){
                    var item = document.createElement('li');
                     item.innerHTML = "<strong><em>Map: </em></strong>" +  "<span>" + risp[i].idMappa + "</span>" + "<p></p>";
                     item.onclick = function () {

                        loadSVG($(this).children("span").text())

                    };

                     list.appendChild(item);



                }
                document.getElementById('lightboxmap').appendChild(list);
                $('#openMap')[0].click();
            }
        }

       xhr.send();

   }

    function androidtoJS(e){
        var matrix = document.getElementById("GroupIcons").getCTM();
        //var json = JSON.stringify(eval("(" + e + ")"));
        //var json = JSON.parse(e);
        //var offset = docPosToMapPos(matrix.e, matrix.f);
        //var offset_Y
        //alert("Sono android " + e["CoordinateStimate"]["pos_X"]);
        var indicator = document.getElementById("Mihai");
        var posx_px = e["CoordinateStimate"]["pos_X"]*metro;
        var posx_py = e["CoordinateStimate"]["pos_Y"]*metro;
        //posx_px = (posx_px*matrix.a)/0.008;
        //posx_py = (posx_py*matrix.a)/0.008;
        if (indicator == null){
            var image = paper.image("static/res/images/indicator.png", (posx_px-((50/0.008)/2)), (posx_py-((50/0.008)/2)), 50/0.008, 50/0.008).attr({
                    id : "Mihai",
                    visibility: "visible"

                });

            var zpdGroup = paper.select("g");

            zpdGroup.append(image);
        }else{
             indicator.remove();
             var image = paper.image("static/res/images/indicator.png", (posx_px-((50/0.008)/2)), (posx_py-((50/0.008)/2)), 50/0.008, 50/0.008).attr({
                    id : "Mihai",
                    visibility: "visible"

                });
            var zpdGroup = paper.select("g");

            zpdGroup.append(image);
            //var indi = paper.select("g")
                     /*indicator.attr({
                'x' : posx_px,
                'y' : posx_py
            });*/
            //alert("Adesso in " + posx_px + " " + posx_py)
            //alert("Adesso in " + indicator.getAttribute("x"))
            //indicator.setAttribute("x", posx_px);
            //indicator.setAttribute("y", posx_py);
        }

        console.log("in indicator " + indicator)
    }

    /*Funzione che gestisce l'evento submit del form per upload di documenti*/
   $('#lightboxform').on('submit', '#uploadForm', function(e){
      console.log($("#inputComment").val());

       var formData = new FormData();
        $('.se-pre-con').css('visibility', 'visible');

       e.preventDefault();

      var TrsfMatrix = document.getElementById('GroupIcons').getCTM();
       var tmp ={
           "idMappa" : "spin1",
           "Title" : $("#inputTitle").val(),
           "Type" : $("#documents").val(),
           "Comment" : $("#inputComment").val(),
           "pos_X" : (parseInt($("#posX").text())*0.008)/TrsfMatrix.a,
           "pos_Y" : (parseInt($("#posY").text())*0.008)/TrsfMatrix.a,
           "pos_Z" : 0
       }

       var filelist = document.getElementById('inputFile');
       var file = filelist.files[0];

       console.log("Nome file " + file.name);
       formData.append('file', file, file.name);
       formData.append('media',  JSON.stringify(tmp));
       this.reset();
       // Set up the request.
        var xhr = new XMLHttpRequest();

       // Open the connection.
        xhr.open('POST', "/document/spin1", true);

        xhr.onload = function () {
            if (xhr.status === 201) {
                 // File(s) uploaded.

                $('.se-pre-con').css('visibility', 'hidden');
                $('.close').click();

                var url = JSON.parse(xhr.responseText);
                tmp["url"] = url
                media.push(tmp);

                console.log("File salvato in " + url)

                var pos_X=((tmp.pos_X*TrsfMatrix.a)/0.008);
                var pos_Y= ((tmp.pos_Y*TrsfMatrix.a)/0.008);
                var position = docPosToMapPos(pos_X, pos_Y);
                var image = paper.image("static/res/icons/"+media[media.length -1 ].Type + "_file.svg#lightboxfile", position.xMapPosition, position.yMapPosition, 30/TrsfMatrix.a, 30/TrsfMatrix.a).attr({
                    id : media.length -1,
                    maxWidth: 30/TrsfMatrix.a,
                    visibility: "visible"

                });
                image.attr({"data-toggle": "modal"});
                image.click(function(evt) {



                    var elementlist = document.getElementById("listFile")
                    if (elementlist != null)
                        elementlist.remove();
                    var list = document.createElement('ul');
                    list.id = "listFile";
                                     //for (var i=0; i<mapGroup[this.attr('id')].length; i++) {
                    var file = media[this.attr('id')].Title
                    var item = document.createElement('li');



                    var path = media[this.attr('id')].url;
                    var filename = path.replace(/^.*[\\\/]/, '');
                    item.innerHTML = "<strong><em>Filename: </em></strong>" +  media[this.attr('id')].Title
                                        + "<strong><em> Type: </em></strong>" +  media[this.attr('id')].Type + "<strong><em> Url: </em></strong>" + "<span>" + filename+ "</span>"
                                        + " <strong><em>Comment: </em></strong>" +  media[this.attr('id')].Comment + "<p></p>";

                    item.onclick = function () {

                        requestfile($(this).children("span").text())

                    };
                    list.appendChild(item);


                    document.getElementById('lightboxfile').appendChild(list);

                });
                var zpdGroup = paper.select("g");

                zpdGroup.append(image);
                console.log("New JSON" + JSON.stringify(media));
                } else {
                         alert('An error occurred!');
            }
        };
       // Send the Data.
       xhr.send(formData);





   });
    function loadSVG(e) {
        $('.close').click();
        /*Funzione per il caricamento della mappa svg*/
        Snap.load("/map/" + e + ".svg", function (f) {

            paper.append(f);

            paper.attr({id: 'graphic_1'});

            var eventsHandler;
            eventsHandler = {
                haltEventListeners: ['touchstart', 'touchend', 'touchmove', 'touchleave', 'touchcancel']
                , init: function (options) {
                    var instance = options.instance
                            , initialScale = 1
                            , pannedX = 0
                            , pannedY = 0
                    // Init Hammer
                    // Listen only for pointer and touch events
                    this.hammer = Hammer(options.svgElement, {
                        inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput
                    })
                    // Enable pinch
                    this.hammer.get('pinch').set({enable: true})
                    // Handle double tap
                    this.hammer.on('doubletap', function (ev) {
                        instance.zoomIn()
                    })
                    // Handle pan
                    this.hammer.on('panstart panmove', function (ev) {
                        zoomSuccess();
                        $('#loadDocument').attr('disabled', 'disabled');
                        $('#addDocument').attr('disabled', 'disabled');
                        // On pan start reset panned variables
                        if (ev.type === 'panstart') {
                            pannedX = 0
                            pannedY = 0
                        }
                        // Pan only the difference
                        instance.panBy({x: ev.deltaX - pannedX, y: ev.deltaY - pannedY})
                        pannedX = ev.deltaX
                        pannedY = ev.deltaY
                    })
                    // Handle pinch
                    this.hammer.on('pinchstart pinchmove', function (ev) {
                        // On pinch start remember initial zoom
                        if (ev.type === 'pinchstart') {
                            initialScale = instance.getZoom()
                            instance.zoom(initialScale * ev.scale)
                        }
                        instance.zoom(initialScale * ev.scale)
                    })
                    // Prevent moving the page on some devices when panning over SVG
                    options.svgElement.addEventListener('touchmove', function (e) {
                        e.preventDefault();
                    });
                }
                , destroy: function () {
                    this.hammer.destroy()
                }
            }
            panZoom = svgPanZoom('#graphic_1', {
                minZoom: 0.80,
                maxZoom: 100,
                zoomEnabled: true,
                panEnabled: true,
                controlIconsEnabled: true,
                fit: 1,
                center: 1,
                customEventsHandler: eventsHandler,

            });

            panZoom.zoom(0.8);

            panZoom.pan({x: 48, y: 21})


            // get the zpd element inside the svg
	   var zpdGroup = paper.select("g");
            zpdGroup.attr({"id" : "GroupIcons"})


            if( (/Firefox/i.test(navigator.userAgent))) {
                paper.node.addEventListener("DOMMouseScroll", zoomSuccess, false);
            } else {
                document.getElementById("GroupIcons").addEventListener("mousewheel", zoomSuccess);
                document.getElementById("GroupIcons").addEventListener("touchmove", zoomSuccess);


            }


            // create a new circle object
            var circle = paper.circle(0, 0, 15).attr({
                fill: "#bada55"
            });

            // add the circle to the zpd group
            zpdGroup.add(circle);



            var box = paper.select("g").getBBox();

            console.log(box);

            requestDocument();


        });




    }


    //Funzione che chiede i documenti al server
    function requestDocument(){

     var xhr = new XMLHttpRequest();
        xhr.open("GET", "/document/spin1", true);
        xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
                // JSON.parse does not evaluate the attacker's scripts.
            var resp = JSON.parse(xhr.responseText);
             media = resp.media;

            console.log("Il server mi ha restituito" + JSON.stringify(media));
            }
        }
        xhr.send();


    }




    function requestfile(e){


        console.log("Ciao " + e)
        NativeInterface.tablet(e)
       //window.open("./res/video/gotham.212.hdtv-lol[ettv].mp4");

    }
    var numGroup=0;
    var mapGroup={};
    var anchor={};
	function  zoomSuccess(){

        var matrix = document.getElementById("GroupIcons").getCTM()



        var g = paper.select("g");

        var image = g.selectAll("image")


        for(var i =0; i<image.length; i++) {

                var sum = image[i].attr("width") / 2 + image[i].attr("width") / 2;
                var diff = image[i].attr("width") / 2 - image[i].attr("width") / 2;
                for (var j = i + 1; j < image.length; j++) {

                        var dist = Math.sqrt(Math.pow(image[j].attr("x") - image[i].attr("x"), 2) + Math.pow(image[j].attr("y") - image[i].attr("y"), 2))

                        if (dist <= sum && dist >= diff) {
                            //console.log("Toccano image" + i + " e image " + j);

                            //console.log(parseFloat(image[j].attr("x")));
                            var x = (parseFloat(image[j].attr("x")) + parseFloat(image[i].attr("x"))) / 2;
                            var y = (parseFloat(image[j].attr("y")) + parseFloat(image[i].attr("y"))) / 2;

                             if (mapGroup[i]== null && mapGroup[j]== null) {


                                mapGroup[j] = numGroup;
                                mapGroup[i] = numGroup;
                                anchor["group" + numGroup] = i;
                                var group = paper.circle(x,y,15/matrix.a).attr({
                                    fill: "#bada55",
			                        id : "group" + numGroup
                                });

                                g.append(group)

                                 mapGroup["group" + numGroup]=[];
                                 mapGroup["group" + numGroup].splice(i, 0 , media[i]);
                                 mapGroup["group" + numGroup].splice(j, 0, media[j]);

                                 numGroup++;
                                 group.attr({"data-toggle": "modal"});
                                 group.attr({href: "#lightboxfile"});
                                 group.click(function(evt) {
                                     var elementlist = document.getElementById("listFile")
                                        if (elementlist != null)
                                                elementlist.remove();
                                     var list = document.createElement('ul');
                                     list.id = "listFile";
                                     for (var i=0; i<mapGroup[this.attr('id')].length; i++) {
                                         var file = mapGroup[this.attr('id')][i].Title
                                         var item = document.createElement('li');

                                         var path =mapGroup[this.attr('id')][i].url;
                                         var filename = path.replace(/^.*[\\\/]/, '');
                                         item.innerHTML = "<strong><em>Filename: </em></strong>" + mapGroup[this.attr('id')][i].Title
                                                 + "<strong><em> Type: </em></strong>" + mapGroup[this.attr('id')][i].Type + "<strong><em> Url: </em></strong>" + "<span>" + filename+ "</span>"
                                                 + " <strong><em>Comment: </em></strong>" + mapGroup[this.attr('id')][i].Comment + "<p></p>";

                                          item.onclick = function () {

                                                requestfile($(this).children("span").text())


                                            };
                                         list.appendChild(item);

                                     }

                                    document.getElementById('lightboxfile').appendChild(list);
                                    });

                                image[j].attr({visibility: "hidden"});
                                image[i].attr({visibility: "hidden"});
                            }else if (mapGroup[i]== null) {

                                 mapGroup[i] = mapGroup[j];
                                  if (i <anchor["group" + mapGroup[i]]){
                                    anchor["group" + mapGroup[i]]=i;
                                }
                                 mapGroup["group" + mapGroup[j]].splice(i, 0 , media[i]);
                                 console.log("valori sono: " + JSON.stringify(mapGroup));
                                image[i].attr({visibility: "hidden"});
                            }else if (mapGroup[j]== null) {

                                 mapGroup[j] = mapGroup[i];
                                  if (j <anchor["group" + mapGroup[j]]){
                                    anchor["group" + mapGroup[j]]=j;
                                }
                                 mapGroup["group" + mapGroup[i]].splice(j, 0, media[j]);
                                 //console.log("valori sono: " + JSON.stringify(mapGroup));
                                image[j].attr({visibility: "hidden"});
                            }
                        } else {
                            //console.log("Non Toccano image " + i + " e image " + j);

                            if ((mapGroup[i] == mapGroup[j]) && mapGroup[i]!=null && mapGroup[j]!=null) {

                               //console.log("i vale: " + i);
                                 //console.log("anchor vale: " +anchor["group" + mapGroup[i]]);
                               //console.log("In anchor c'è " +JSON.stringify(anchor));
                                mapGroup["group" + mapGroup[i]].splice((i - anchor["group" + mapGroup[i]]), 1);

                                if( i == anchor["group" + mapGroup[i]]){
                                    anchor["group" + mapGroup[i]] = i+1;
                                }

                                //console.log("Il mapGroup contiene n: " + mapGroup["group" + mapGroup[i]].length);
                                if(mapGroup["group" + mapGroup[i]].length == 1) {
                                    //console.log("C'è un solo elemento nel gruppo situazione mapgroup " + JSON.stringify(mapGroup) );
                                     mapGroup["group" + mapGroup[i]].splice(0, 1);
                                    $("#group" + mapGroup[j]).remove();
                                    numGroup=mapGroup[j];
                                     mapGroup[j]=null;
                                    image[j].attr({visibility: "visible"});
                                    image[i].attr({visibility: "visible"});

                                }
                                mapGroup[i]=null;

                                //console.log("sono qui per colpa di image" + i + " e image " + j);
                                //console.log("valori sono: " + JSON.stringify(mapGroup));

                                image[i].attr({visibility: "visible"});

                            }


                        }

                }

        }

        for (var j =0; j<image.length; j++) {
            image[j].attr({
                'height': (30 / matrix.a),
                'width': (30 / matrix.a)
            });
        }
        var cir =g.selectAll("circle") ;
        for (var j =1; j<cir.length; j++) {
            cir[j].attr({

                'r' : (15/matrix.a)
            });
        }

	}
   // UI improvement needed
    var intervalF;
    var clearIntervalF = function () {
        clearInterval(intervalF);
    };
    document.getElementById('drawSquare').onmousedown = function () {
		paper.rect(100,100,100,100);
        applyZpd();

    };
	document.getElementById('reset').onmousedown = function () {

        panZoom.zoom(0.8);
        panZoom.pan({x: x_pan, y: y_pan});
        if (loaded == false)
            $('#loadDocument').removeAttr("disabled");
        $('#addDocument').removeAttr("disabled");



    };




	document.getElementById('drawSquareInside').onmousedown = function () {

        var indicator = document.getElementById("4");
        var g = paper.select("g");
        var images = g.selectAll("image");
        images[10].attr({
            'x' : 48000
        })


    };

	document.getElementById('loadIconInside').onmousedown = function () {
		// get the zpd element inside the svg
		var zpdGroup = paper.select("g");
		Snap.load('static/res/icons/video_file.svg',function(data){
			console.log(data);

			zpdGroup.append(data);
		});



    };

    document.getElementById('loadIcon').onmousedown = function () {
        var zpdGroup=paper.select("g");
        var matrix = document.getElementById("GroupIcons").getCTM()

        var position11 = docPosToMapPos(362.38, 425.24)
        var position22 = docPosToMapPos(354.92, 642.51);
        var position33 = docPosToMapPos(598.21, 425.24);
        var position44 = docPosToMapPos(603.80, 771.27);
        var my_position= docPosToMapPos(481.97, 601.83);
        /*console.log("ID:4664 " + (position44.xMapPosition*matrix.a)/0.008 + " " + position4.yDocPosition);
        console.log("ID:4662 " + position1.xDocPosition + " " + position1.yDocPosition);
        console.log("ID:4668 " + position2.xDocPosition + " " + position2.yDocPosition);
        console.log("ID:4665 " + position3.xDocPosition + " " + position3.yDocPosition);*/
        var circle1 = paper.circle(39107.77958, 50288.0582, 15/0.008).attr({
            id: "sensor1",
            fill: "#00d2ff"
        });

        var circle2 = paper.circle(38179.95562, 88653.57861, 15/0.008).attr({
            id: "sensor2",
            fill: "#00d2ff"
        });
        var circle3 = paper.circle(68427.01646, 50288.0582, 15/0.008).attr({
            id: "sensor3",
            fill: "#00d2ff"
        });
        var circle4 = paper.circle(69122.88442, 93292.69837, 15/0.008).attr({
            id: "sensor4",
            fill: "#00d2ff"
        });
        /*
        var circle5 = paper.circle(55669.4371, 78865.03, 15/0.008).attr({
            id: "sensor4",
            fill: "#ffffff"
        });
        */
        var circle6 = paper.circle(38875.82359, 70236.27317, 15/0.008).attr({
            id: "sensor5",
            fill: "#00d2ff"
        });
         var circle7 = paper.circle(69818.75239, 66061.06538, 15/0.008).attr({
             id: "sensor6",
            fill: "#00d2ff"
        });
        var position1 = mapPosToDocPos(39096.2108, 50270.3781);
        var position2 = mapPosToDocPos(68422.81681, 50270.3781);
        var position3 = mapPosToDocPos(38168.6141, 77297.58089);
        var position4 = mapPosToDocPos(69118.68477, 93302.54407);

        console.log("ID:4664 " + position4.xDocPosition + " " + position4.yDocPosition);
        console.log("ID:4662 " + position1.xDocPosition + " " + position1.yDocPosition);
        console.log("ID:4668 " + position2.xDocPosition + " " + position2.yDocPosition);
        console.log("ID:4665 " + position3.xDocPosition + " " + position3.yDocPosition);
        // add the circle to the zpd group
        zpdGroup.add(circle1);
        zpdGroup.add(circle2);
        zpdGroup.add(circle3);
        zpdGroup.add(circle4);
        //zpdGroup.add(circle5);
        zpdGroup.add(circle6);
        zpdGroup.add(circle7);
    };

    //Funzione che permette l'aggiunta di un documento alla mappa
    document.getElementById('addDocument').onmousedown = function (){
        var zpdGroup = paper.select("g");
        zpdGroup.attr({"data-toggle": "modal"});
        zpdGroup.attr({href: "#lightboxform"});
        zpdGroup.click(function(evt) {
            console.log("Var x" + evt.pageX + "Var y" + evt.pageY);
            var pos = docPosToMapPos(evt.pageX, evt.pageY);
            console.log("In pixel " + pos.xMapPosition + " " + pos.yMapPosition);
            $('#posX').text(evt.pageX);
            $('#posY').text(evt.pageY);


       });
        var image = zpdGroup.selectAll("image")
        console.log("In image ci sono " + image.length);
        for (var i =0; i< image.length; i++){
            image[i].attr({visibility: "hidden"});
        }
        var group = zpdGroup.selectAll("circle")
        for (var i =0; i< group.length; i++){
            group[i].attr({visibility: "hidden"});
        }
        $('.button').css('visibility', 'hidden');
        var finish = document.createElement("button");
        finish.id = "FinishAdd";
        var t = document.createTextNode("FinishAdd");
        finish.appendChild(t);

        finish.className = "button";

        finish.onclick = function() { // Note this is a function
            if (group.length != 0) {
                for (var i = 0; i < group.length; i++) {
                    group[i].attr({visibility: "visible"});
                }
            }
            if  (image.length != 0) {
                for (var i = 0; i < image.length; i++) {
                    if (mapGroup[i] == null)
                        image[i].attr({visibility: "visible"});
                }

            }
                zoomSuccess();

                        document.body.removeChild(finish);
                        $('.button').css('visibility', 'visible');
                        zpdGroup.attr({"data-toggle": ""});
                        zpdGroup.attr({href: ""});
                        zpdGroup.unclick();
                    };
        document.body.appendChild(finish);



    };
    //Funzione che carica i documenti sulla mappa
	document.getElementById('loadDocument').onmousedown = function (){


            media.sort(function(a,b){
               return a.pos_X - b.pos_X;
            });



            var TrsfMatrix = document.getElementById('GroupIcons').getCTM();


            for (var i = 0; i < media.length; i++) {


                var x= (media[i].pos_X*TrsfMatrix.a)/0.008;
                var y = (media[i].pos_Y*TrsfMatrix.a)/0.008;
                //console.log("x originale" + media[i].pos_X + "y originale " + media[i].pos_Y + "x varia " + x + "y varia" + y + "Zoom" + TrsfMatrix.a);


                //console.log(m2px(media[i].pos_X), m2px(media[i].pos_Y));
                //console.log("La posizione sulla mappa in x,y è " + media[i].pos_X + " " + media[i].pos_Y);

                var pos_X=((media[i].pos_X*TrsfMatrix.a)/0.008);
                var pos_Y= ((media[i].pos_Y*TrsfMatrix.a)/0.008);
                var position = docPosToMapPos(pos_X, pos_Y);
                //console.log("La posizione sulla mappa in pixel è " + position.xMapPosition + " " + position.yMapPosition + "l'offset è " + TrsfMatrix.e + " " +TrsfMatrix.f);
                var image = paper.image("static/res/icons/"+media[i].Type + "_file.svg#lightboxfile", position.xMapPosition , position.yMapPosition , 30/TrsfMatrix.a, 30/TrsfMatrix.a).attr({
                    id : i,
                    maxWidth: 30/TrsfMatrix.a,
                    visibility: "visible",

                });
                //console.log(window.screen.availHeight + " " + window.screen.availWidth);
                image.attr({"data-toggle": "modal"});

                image.click(function(evt) {

                        var elementlist = document.getElementById("listFile")
                        if (elementlist != null)
                            elementlist.remove();
                        var list = document.createElement('ul');
                        list.id = "listFile";
                                     //for (var i=0; i<mapGroup[this.attr('id')].length; i++) {
                        //var file = media[this.attr('id')].Title
                        var item = document.createElement('li');



                        var path = media[this.attr('id')].url;
                        var filename = path.replace(/^.*[\\\/]/, '');
                        item.innerHTML = "<strong><em>Filename: </em></strong>" +  media[this.attr('id')].Title
                                        + "<strong><em> Type: </em></strong>" +  media[this.attr('id')].Type + "<strong><em> Url: </em></strong>" + "<span>" + filename+ "</span>"
                                        + " <strong><em>Comment: </em></strong>" +  media[this.attr('id')].Comment + "<p></p>";

                    item.onclick = function () {

                        requestfile($(this).children("span").text())

                    };
                    list.appendChild(item);


                    document.getElementById('lightboxfile').appendChild(list);

                    });

                //console.log("Aggiunto cerchio " + i + "x " + position.xMapPosition + "y " + position.yMapPosition);

                var zpdGroup = paper.select("g");

                zpdGroup.append(image);
            }

            zoomSuccess();
        $('#loadDocument').attr('disabled', 'disabled');
        loaded = true;


    }

   /* $("#icon0").click(function getClick(e){
        window.alert("Cliccato su image");

    });
    paper.image.click = function() {
        alert("Cliccato su image");
    };
    */
	/*$(document).click(function getClickPosition(e) {
    
    var xPosition = e.pageX ;
    var yPosition = e.pageY;
     
    //theThing.style.left = xPosition + "px";
    //theThing.style.top = yPosition + "px";
	
	 
	
	var TrsfMatrix = paper.zpd('save');
	
	var xMapPosition = (xPosition - TrsfMatrix.e)/TrsfMatrix.a;
	var yMapPosition= (yPosition - TrsfMatrix.f)/TrsfMatrix.a;
	
	//window.alert("ClickPosition " + xPosition + "px, " + yPosition + "px   Map: " + xMapPosition + "px, " + yMapPosition + "px   " +px2m(xMapPosition)+"m " +px2m(yMapPosition)+"m ");
	console.log("ClickPosition " + xPosition + "px, " + yPosition + "px   Map: " + xMapPosition + "px, " + yMapPosition + "px   " +px2m(xMapPosition)+"m " +px2m(yMapPosition)+"m " + m2px(px2m(xMapPosition))+"px ");
	
	var doc2Map = docPosToMapPos(xPosition,yPosition);
	
	console.log("docPosition:" +doc2Map.xMapPosition +"x "+doc2Map.yMapPosition +"y")
	
	var map2Doc = mapPosToDocPos(doc2Map.xMapPosition,doc2Map.yMapPosition)
	
	console.log("mapPosition:" +map2Doc.xDocPosition +"x "+map2Doc.yDocPosition +"y")
	
	var zpdGroup = paper.select("g");

		// create a new circle object
		var circle = paper.circle(doc2Map.xMapPosition,doc2Map.yMapPosition,15/TrsfMatrix.a).attr({
			fill: "#bada55",
			id : 'c1'
		});

		// add the circle to the zpd group
		zpdGroup.add(circle);
	
});
	*/
	var px2m = function(px){
	return (30/106299.248)*px
	}
	
	var m2px = function(m)	{
	//return 1/px2m(m);
        return m/(30/106299.248);
	}
	
	var docPosToMapPos = function(xPix,yPix){
		//var TrsfMatrix = paper.zpd('save');
        var TrsfMatrix=document.getElementById("GroupIcons").getCTM();
        console.log("La matrice di trasformazione è " + TrsfMatrix.a, TrsfMatrix.e, TrsfMatrix.f);
		var xMapPosition = (xPix - TrsfMatrix.e)/TrsfMatrix.a;
		var yMapPosition = (yPix - TrsfMatrix.f)/TrsfMatrix.a;
		return {
				xMapPosition: xMapPosition,
				yMapPosition: yMapPosition
				};
	}
	
	var mapPosToDocPos = function(xPix,yPix){
        var TrsfMatrix=document.getElementById("GroupIcons").getCTM();
		//var TrsfMatrix = paper.zpd('save');
		var xDocPosition = xPix * TrsfMatrix.a + TrsfMatrix.e
		var yDocPosition = yPix * TrsfMatrix.a + TrsfMatrix.f
		
		return {
				xDocPosition: xDocPosition,
				yDocPosition: yDocPosition
				};		
	}
	

</script>
</body>

</html>
